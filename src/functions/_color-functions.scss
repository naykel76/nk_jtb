@use '../maps_and_variables/base' as *;
@use 'sass:color';

// Shared threshold for consistency across all lightness calculations
// for OKLCH (0-100 scale), for RGB (0-255 scale)
$lightness-threshold-oklch: 75 !default;
$lightness-threshold-rgb: 153 !default;

// ============================================================================
// OKLCH Lightness Check
// ============================================================================
// Determines if an OKLCH color is light or dark based on its lightness channel.
// OKLCH lightness in Sass is represented as a percentage (0-100), not decimal.
//
// @param {Color} $color - The OKLCH color to evaluate
// @param {Number} $threshold - Lightness threshold (0-100 scale)
// @return {Boolean} - True if light, false if dark
// ============================================================================
@function oklch-is-light($color, $threshold: $lightness-threshold-oklch) {
    $lightness: color.channel($color, 'lightness', $space: oklch);

    @return $lightness > $threshold;
}

// ============================================================================
// RGB Brightness Check (Using Relative Luminance)
// ============================================================================
// Determines if a color is light or dark using WCAG relative luminance formula.
// This gives perceptually accurate results based on how human eyes work.
//
// @param {Color} $color - The color to evaluate (converted to RGB if needed)
// @param {Number} $threshold - Brightness threshold (0-255 scale)
// @return {Boolean} - True if light, false if dark
// ============================================================================
@function rgb-is-light($color, $threshold: $lightness-threshold-rgb) {
    $rgb-color: color.to-space($color, rgb);

    // Calculate relative luminance using WCAG formula for perceived brightness
    // Human eyes are most sensitive to green (71.52%), red (21.26%), blue (7.22%)
    $brightness: 0.2126 * color.channel($rgb-color, 'red') + 0.7152 * color.channel($rgb-color, 'green') + 0.0722 *
        color.channel($rgb-color, 'blue');

    @return $brightness > $threshold;
}

// ============================================================================
// Text Color Selector
// ============================================================================
// Returns appropriate text color (dark or light) based on background color.
// Automatically detects color space and uses optimal calculation method:
// - OKLCH colors use native lightness channel
// - All other colors (RGB, HSL, etc.) use RGB brightness calculation
//
// @param {Color} $bg-color - The background color to evaluate
// @return {Color} - Either $text-dark or $text-light for optimal contrast
// ----------------------------------------------------------------------------
@function text-color($bg-color) {
    // Detect which color space the background color is using
    $color-space: color.space($bg-color);

    // Choose appropriate lightness calculation based on color space
    $is-light: null;

    @if $color-space == oklch {
        $is-light: oklch-is-light($bg-color);
    } @else {
        $is-light: rgb-is-light($bg-color);
    }

    // Return dark text for light backgrounds, light text for dark backgrounds
    @if $is-light {
        @return $text-dark;
    }

    @return $text-light;
}

// ============================================================================
// border-contrast($bg, $opacity)
// ============================================================================
// Returns a semi-transparent black or white based on background lightness.
//
// Uses HSL lightness to determine which gives better contrast.
// Good for accessibility, though may lack visual harmony.
//
// Pros:
// - Ensures reliable contrast on any background
// - Ideal for accessibility overlays and outlines
//
// Cons:
// - Not derived from the original colour
// - Can feel visually disconnected
//
// Best for: High-contrast elements where legibility is key
// ----------------------------------------------------------------------------

@function border-contrast($bg, $opacity: 0.15) {
    $lightness: color.channel($bg, 'lightness', $space: hsl);

    @if $lightness > 50 {
        @return color.change(black, $alpha: $opacity);
    } @else {
        @return color.change(white, $alpha: $opacity);
    }
}
